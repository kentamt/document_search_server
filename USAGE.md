# 類似文献検索モジュールの使い方

| Item             |  Date                |
| -----------------| -------------------- |
|  **Author**         |  oplab Inc.            |
|  **Created at**      |  2019-08-25            |
|  **Updated at**      |  2019-08-25            |


## はじめに
**学習**：
各文献の潜在的なトピックを数値化するためのモデルを作成します。
全文献を対象として処理を行うため、時間がかかります。
そのため、ある程度文献が溜まったタイミングで学習を行うことを想定しています。
学習後にはtopic modelというファイルが生成されます。

**類似文献検索**：
ひとつの文献IDを入力とし、その文献に類似するものを検索します。

**新規文献追加**：
学習時に含まれていなかった文献を類似文献の検索結果に反映するために行います。


## 起動方法
ソースコード一式を適当な場所に配置し、そのディレクトリに移動します。
```
$ cd recmodule
```
`docker-compose.yml`が同一階層にあることを確認し、
`docker-compose` コマンドでDockerコンテナを起動します。
（初回は、Dockerイメージがビルドされるため、少し時間がかかります。）
```
$ docker-compose up -d
```
実行ログは、`docker-compose logs -f` などで確認してください。
起動が完了したかどうかは、`/model`にGETリクエストをして確認することができます。
```
# 起動完了している場合 （未学習の場合）
$ curl -X GET http://0.0.0.0:5000/model
#=> {"error":"Topic model has not been created."}

# 起動完了している場合 （学習済みの場合）
$ curl -X GET http://0.0.0.0:5000/model
#=> {"message":"Success","model_create_datetime":"2019/08/25_07:25:53","num_docs":300,"num_topics":10}
```
デフォルトではポート番号は5000としていますが、`docker-compose.yml` ファイルを編集することで任意のポート番号に変更することが可能です。

モジュールを終了するには、`docker-compose.yml` のあるディレクトリで次のコマンドを実行します。
```
$ docker-compose down
```

初回起動時のみ（あるいは新たに学習を行いたい場合のみ）、後述の学習処理を行ってください。

## 学習方法
### 文献データの渡し方
次のようなcsvファイルを、`app/test`ディレクトリに`test_data.csv`というファイル名で配置してください。
```
ID, abstract,
1001, "this is a sample document."
1002, "this is also a sample document."
```
学習時にはこのファイルが取り込まれます。

インストール後、`/model/train` を利用することで、topic modelを作成することができます。
```
$ curl http://0.0.0.0:5000/model/train -X POST -d '{"num_topics": 10, "num_pass" : 1}'
```
作成されたtopic modelは `topic_model_2019.08.25_07.30.21.pickle` のように日付付きのファイル名で`app/`ディレクトリに保存されます。
最新10個までは保存され、それ以後古いものから削除されます。

### 学習時のハイパーパラメータについて
`/model/train` には設定可能なパラメータが2つあります。

* `num_topics`
* `num_pass`

`num_topics` は、全文献を何個のトピックに振り分けるかを意味します。
`num_pass` は、何回学習を繰り返すかを意味しており、数字が大きい場合には時間がかかりますが、学習を収束させることができます。

### 学習結果のバックアップ
`app/` ディレクトリに保存されている`topic_model_日付.pickle` というファイルを別の場所に保存してください。
`docker-compose up`でモジュールを起動する際に、`app/`にある最新の日付のものを読み込みます。

## 類似文献検索
学習が完了していれば、`GET /docs/:id`にリクエストすることで、類似文献を検索することができます。
詳細はAPIDOC.mdを参照してください。

## 新規文献追加
学習が完了していれば、`POST /docs/add`にリクエストすることで、新規文献を追加することができます。
詳細はAPIDOC.mdを参照してください。


---

## お問い合わせ 
学習モデル作成時のパラメータの調整方法については、ぜひ弊社にご相談ください。
トピックや単語の分布などを可視化し、より効果的なパラメータを決定する方法のご提案が可能です。

連絡先: 
akira_matsui@oplab.jp